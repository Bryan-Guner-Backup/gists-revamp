<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>server-rendering</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<p><a href="../index.html" class="navbar__brand"> <img src="../official/d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo" /> <strong>Redux</strong> </a></p>
<p><a href="../introduction/getting-started.html" class="navbar__item navbar__link">Getting Started</a> <a href="../tutorials/essentials/part-1-overview-concepts.html" class="navbar__item navbar__link">Tutorial</a> <a href="../api/api-reference.html" class="navbar__item navbar__link">API</a> <a href="../faq.html" class="navbar__item navbar__link">FAQ</a> <a href="../style-guide/style-guide.html" class="navbar__item navbar__link">Best Practices</a> <a href="../official/github.com/reduxjs/redux.html" class="navbar__item navbar__link">GitHub</a> <a href="../introduction/getting-started.html#help-and-discussion" class="navbar__item navbar__link">Need help?</a> <a href="../index.html" class="navbar__brand"> <img src="../official/d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo" /> <strong>Redux</strong> </a></p>
<ul>
<li><a href="../introduction/getting-started.html" class="menu__link">Getting Started</a></li>
<li><a href="../tutorials/essentials/part-1-overview-concepts.html" class="menu__link">Tutorial</a></li>
<li><a href="../api/api-reference.html" class="menu__link">API</a></li>
<li><a href="../faq.html" class="menu__link">FAQ</a></li>
<li><a href="../style-guide/style-guide.html" class="menu__link">Best Practices</a></li>
<li><a href="../official/github.com/reduxjs/redux.html" class="menu__link">GitHub</a></li>
<li><p><a href="../introduction/getting-started.html#help-and-discussion" class="menu__link">Need help?</a></p></li>
<li><a href="#!" class="menu__link menu__link--sublist">Introduction</a>
<ul>
<li><a href="../introduction/getting-started.html" class="menu__link">Getting Started with Redux</a></li>
<li><a href="../introduction/installation.html" class="menu__link">Installation</a></li>
<li><a href="../introduction/core-concepts.html" class="menu__link">Core Concepts</a></li>
<li><a href="../introduction/learning-resources.html" class="menu__link">Learning Resources</a></li>
<li><a href="../introduction/ecosystem.html" class="menu__link">Ecosystem</a></li>
<li><a href="../introduction/examples.html" class="menu__link">Examples</a></li>
</ul></li>
<li><p><a href="#!" class="menu__link menu__link--sublist">Tutorials</a></p>
<ul>
<li><a href="../tutorials/index.html" class="menu__link">Tutorials Index</a></li>
<li><a href="../tutorials/quick-start.html" class="menu__link">Quick Start</a></li>
<li><a href="../tutorials/typescript-quick-start.html" class="menu__link">TypeScript Quick Start</a></li>
<li><p><a href="#!" class="menu__link menu__link--sublist">Redux Essentials</a></p>
<ul>
<li><a href="../tutorials/essentials/part-1-overview-concepts.html" class="menu__link">Redux Overview and Concepts</a></li>
<li><a href="../tutorials/essentials/part-2-app-structure.html" class="menu__link">Redux App Structure</a></li>
<li><a href="../tutorials/essentials/part-3-data-flow.html" class="menu__link">Basic Redux Data Flow</a></li>
<li><a href="../tutorials/essentials/part-4-using-data.html" class="menu__link">Using Redux Data</a></li>
<li><a href="../tutorials/essentials/part-5-async-logic.html" class="menu__link">Async Logic and Data Fetching</a></li>
<li><p><a href="../tutorials/essentials/part-6-performance-normalization.html" class="menu__link">Performance and Normalizing Data</a></p></li>
<li><a href="../tutorials/fundamentals/part-1-overview.html" class="menu__link">Redux Overview</a></li>
<li><a href="../tutorials/fundamentals/part-2-concepts-data-flow.html" class="menu__link">Redux Concepts and Data Flow</a></li>
<li><a href="../tutorials/fundamentals/part-3-state-actions-reducers.html" class="menu__link">State, Actions, and Reducers</a></li>
<li><a href="../tutorials/fundamentals/part-4-store.html" class="menu__link">Store</a></li>
<li><a href="../tutorials/fundamentals/part-5-ui-react.html" class="menu__link">UI and React</a></li>
<li><a href="../tutorials/fundamentals/part-6-async-logic.html" class="menu__link">Async Logic and Data Fetching</a></li>
<li><a href="../tutorials/fundamentals/part-7-standard-patterns.html" class="menu__link">Standard Redux Patterns</a></li>
<li><p><a href="../tutorials/fundamentals/part-8-modern-redux.html" class="menu__link">Modern Redux with Redux Toolkit</a></p></li>
</ul></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist menu__link--active">Recipes</a>
<ul>
<li><a href="recipe-index.html" class="menu__link">Recipes: Index</a></li>
<li><a href="configuring-your-store.html" class="menu__link">Configuring Your Store</a></li>
<li><a href="usage-with-typescript.html" class="menu__link">Usage With TypeScript</a></li>
<li><a href="migrating-to-redux.html" class="menu__link">Migrating to Redux</a></li>
<li><a href="using-object-spread-operator.html" class="menu__link">Using Object Spread Operator</a></li>
<li><a href="reducing-boilerplate.html" class="menu__link">Reducing Boilerplate</a></li>
<li><a href="server-rendering.html" class="menu__link menu__link--active active">Server Rendering</a></li>
<li><a href="writing-tests.html" class="menu__link">Writing Tests</a></li>
<li><a href="computing-derived-data.html" class="menu__link">Computing Derived Data</a></li>
<li><a href="implementing-undo-history.html" class="menu__link">Implementing Undo History</a></li>
<li><a href="isolating-redux-sub-apps.html" class="menu__link">Isolating Redux Sub-Apps</a></li>
<li><a href="code-splitting.html" class="menu__link">Code Splitting</a></li>
<li><a href="troubleshooting.html" class="menu__link">Troubleshooting</a></li>
<li><a href="#!" class="menu__link menu__link--sublist">Structuring Reducers</a>
<ul>
<li><a href="structuring-reducers/structuring-reducers.html" class="menu__link">Structuring Reducers</a></li>
<li><a href="structuring-reducers/prerequisite-concepts.html" class="menu__link">Prerequisite Concepts</a></li>
<li><a href="structuring-reducers/basic-reducer-structure.html" class="menu__link">Basic Reducer Structure</a></li>
<li><a href="structuring-reducers/splitting-reducer-logic.html" class="menu__link">Splitting Reducer Logic</a></li>
<li><a href="structuring-reducers/refactoring-reducer-example.html" class="menu__link">Refactoring Reducers Example</a></li>
<li><a href="structuring-reducers/using-combinereducers.html" class="menu__link">Using combineReducers</a></li>
<li><a href="structuring-reducers/beyond-combinereducers.html" class="menu__link">Beyond combineReducers</a></li>
<li><a href="structuring-reducers/normalizing-state-shape.html" class="menu__link">Normalizing State Shape</a></li>
<li><a href="structuring-reducers/updating-normalized-data.html" class="menu__link">Updating Normalized Data</a></li>
<li><a href="structuring-reducers/reusing-reducer-logic.html" class="menu__link">Reusing Reducer Logic</a></li>
<li><a href="structuring-reducers/immutable-update-patterns.html" class="menu__link">Immutable Update Patterns</a></li>
<li><a href="structuring-reducers/initializing-state.html" class="menu__link">Initializing State</a></li>
</ul></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">Understanding Redux</a>
<ul>
<li><a href="#!" class="menu__link menu__link--sublist">Thinking in Redux</a>
<ul>
<li><a href="../understanding/thinking-in-redux/motivation.html" class="menu__link">Motivation</a></li>
<li><a href="../understanding/thinking-in-redux/three-principles.html" class="menu__link">Three Principles</a></li>
<li><a href="../understanding/thinking-in-redux/glossary.html" class="menu__link">Glossary</a></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">History and Design</a>
<ul>
<li><a href="../understanding/history-and-design/prior-art.html" class="menu__link">Prior Art</a></li>
<li><a href="../understanding/history-and-design/middleware.html" class="menu__link">Middleware</a></li>
</ul></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">FAQ</a>
<ul>
<li><a href="../faq.html" class="menu__link">FAQ Index</a></li>
<li><a href="../faq/general.html" class="menu__link">General</a></li>
<li><a href="../faq/reducers.html" class="menu__link">Reducers</a></li>
<li><a href="../faq/organizing-state.html" class="menu__link">Organizing State</a></li>
<li><a href="../faq/store-setup.html" class="menu__link">Store Setup</a></li>
<li><a href="../faq/actions.html" class="menu__link">Actions</a></li>
<li><a href="../faq/immutable-data.html" class="menu__link">Immutable Data</a></li>
<li><a href="../faq/code-structure.html" class="menu__link">Code Structure</a></li>
<li><a href="../faq/performance.html" class="menu__link">Performance</a></li>
<li><a href="../faq/design-decisions.html" class="menu__link">Design Decisions</a></li>
<li><a href="../faq/react-redux.html" class="menu__link">React Redux</a></li>
<li><a href="../faq/miscellaneous.html" class="menu__link">Miscellaneous</a></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">Style Guide</a>
<ul>
<li><a href="../style-guide/style-guide.html" class="menu__link">Style Guide: Best Practices</a></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">API Reference</a>
<ul>
<li><a href="../api/api-reference.html" class="menu__link">API Reference</a></li>
<li><a href="../api/createstore.html" class="menu__link">createStore</a></li>
<li><a href="../api/store.html" class="menu__link">Store</a></li>
<li><a href="../api/combinereducers.html" class="menu__link">combineReducers</a></li>
<li><a href="../api/applymiddleware.html" class="menu__link">applyMiddleware</a></li>
<li><a href="../api/bindactioncreators.html" class="menu__link">bindActionCreators</a></li>
<li><a href="../api/compose.html" class="menu__link">compose</a></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">Redux Toolkit</a>
<ul>
<li><a href="../redux-toolkit/overview.html" class="menu__link">Redux Toolkit: Overview</a></li>
</ul></li>
</ul>
<h1 id="section"><span id="server-rendering" class="anchor enhancedAnchor_2LWZ"></h1>
<p></span>Server Rendering<a href="#server-rendering" class="hash-link" title="Direct link to heading">#</a></p>
<p>The most common use case for server-side rendering is to handle the <em>initial render</em> when a user (or search engine crawler) first requests our app. When the server receives the request, it renders the required component(s) into an HTML string, and then sends it as a response to the client. From that point on, the client takes over rendering duties.</p>
<p>We will use React in the examples below, but the same techniques can be used with other view frameworks that can render on the server.</p>
<h3 id="section-1"><span id="redux-on-the-server" class="anchor enhancedAnchor_2LWZ"></h3>
<p></span>Redux on the Server<a href="#redux-on-the-server" class="hash-link" title="Direct link to heading">#</a></p>
<p>When using Redux with server rendering, we must also send the state of our app along in our response, so the client can use it as the initial state. This is important because, if we preload any data before generating the HTML, we want the client to also have access to this data. Otherwise, the markup generated on the client won’t match the server markup, and the client would have to load the data again.</p>
<p>To send the data down to the client, we need to:</p>
<ul>
<li>create a fresh, new Redux store instance on every request;</li>
<li>optionally dispatch some actions;</li>
<li>pull the state out of store;</li>
<li>and then pass the state along to the client.</li>
</ul>
<p>On the client side, a new Redux store will be created and initialized with the state provided from the server. Redux’s <strong><em>only</em></strong> job on the server side is to provide the <strong>initial state</strong> of our app.</p>
<h2 id="section-2"><span id="setting-up" class="anchor enhancedAnchor_2LWZ"></h2>
<p></span>Setting Up<a href="#setting-up" class="hash-link" title="Direct link to heading">#</a></p>
<p>In the following recipe, we are going to look at how to set up server-side rendering. We’ll use the simplistic <a href="../../github.com/reduxjs/redux/tree/master/examples/counter.html">Counter app</a> as a guide and show how the server can render state ahead of time based on the request.</p>
<h3 id="section-3"><span id="install-packages" class="anchor enhancedAnchor_2LWZ"></h3>
<p></span>Install Packages<a href="#install-packages" class="hash-link" title="Direct link to heading">#</a></p>
<p>For this example, we’ll be using <a href="../../expressjs.com/index.html">Express</a> as a simple web server. We also need to install the React bindings for Redux, since they are not included in Redux by default.</p>
<p><span class="token plain">npm install express react-redux</span>## <span id="the-server-side" class="anchor enhancedAnchor_2LWZ"> </span>The Server Side<a href="#the-server-side" class="hash-link" title="Direct link to heading">#</a></p>
<p>The following is the outline for what our server side is going to look like. We are going to set up an <a href="../../expressjs.com/guide/using-middleware.html">Express middleware</a> using <a href="../../expressjs.com/api.html#app.use">app.use</a> to handle all requests that come in to our server. If you’re unfamiliar with Express or middleware, just know that our handleRender function will be called every time the server receives a request.</p>
<p>Additionally, as we are using ES6 and JSX syntax, we will need to compile with <a href="../../babeljs.io/index.html">Babel</a> (see <a href="../../github.com/babel/example-node-server.html">this example of a Node Server with Babel</a>) and the <a href="../../babeljs.io/docs/plugins/preset-react/index.html">React preset</a>.</p>
<h5 id="section-4"><span id="serverjs" class="anchor enhancedAnchor_2LWZ"></h5>
<p></span><code>server.js</code><a href="#serverjs" class="hash-link" title="Direct link to heading">#</a></p>
<p><span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span>path</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘path’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports maybe-class-name">Express</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘express’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports maybe-class-name">React</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> createStore </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘redux’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> </span> <span class="token imports maybe-class-name">Provider</span> <span> </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react-redux’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span>counterApp</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘./reducers’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports maybe-class-name">App</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘./containers/App’</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> app </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token function maybe-class-name" style="color: #e6d874">Express</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> port </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token number" style="color: #ae81ff">3000</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">//Serve static files</span> <span class="token plain"> </span></p>
<p><span class="token plain">app</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">use</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token string" style="color: #a6e22e">‘/static’</span> <span class="token punctuation" style="color: #f8f8f2">,</span> <span class="token plain"> </span> <span class="token maybe-class-name">Express</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">static</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token string" style="color: #a6e22e">‘static’</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// This is fired every time the server side receives a request</span> <span class="token plain"> </span></p>
<p><span class="token plain">app</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">use</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">handleRender</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// We are going to fill these out in the sections to follow</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">function</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">handleRender</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token parameter">req</span> <span class="token parameter punctuation" style="color: #f8f8f2">,</span> <span class="token parameter"> res</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">/* … */</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">function</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">renderFullPage</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token parameter">html</span> <span class="token parameter punctuation" style="color: #f8f8f2">,</span> <span class="token parameter"> preloadedState</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">/* … */</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain">app</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">listen</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">port</span> <span class="token punctuation" style="color: #f8f8f2">)</span>### <span id="handling-the-request" class="anchor enhancedAnchor_2LWZ"> </span>Handling the Request<a href="#handling-the-request" class="hash-link" title="Direct link to heading">#</a></p>
<p>The first thing that we need to do on every request is to create a new Redux store instance. The only purpose of this store instance is to provide the initial state of our application.</p>
<p>When rendering, we will wrap <code>&lt;App /&gt;</code>, our root component, inside a <code>&lt;Provider&gt;</code> to make the store available to all components in the component tree, as we saw in <a href="../tutorials/fundamentals/part-5-ui-react.html">“Redux Fundamentals” Part 5: UI and React</a>.</p>
<p>The key step in server side rendering is to render the initial HTML of our component <strong><em>before</em></strong> we send it to the client side. To do this, we use <a href="../../reactjs.org/docs/react-dom-server.html#rendertostring">ReactDOMServer.renderToString()</a>.</p>
<p>We then get the initial state from our Redux store using <a href="../api/store.html#getState"><code>store.getState()</code></a>. We will see how this is passed along in our <code>renderFullPage</code> function.</p>
<p><span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> renderToString </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react-dom/server’</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">function</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">handleRender</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token parameter">req</span> <span class="token parameter punctuation" style="color: #f8f8f2">,</span> <span class="token parameter"> res</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Create a new Redux store instance</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> store </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">createStore</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">counterApp</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Render the component to a string</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> html </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">renderToString</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">&lt;</span> <span class="token maybe-class-name">Provider</span> <span class="token plain"> store</span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain">store</span> <span class="token punctuation" style="color: #f8f8f2">}</span> <span class="token operator" style="color: #f8f8f2">&gt;</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">&lt;</span> <span class="token maybe-class-name">App</span> <span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">/</span> <span class="token operator" style="color: #f8f8f2">&gt;</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">&lt;</span> <span class="token operator" style="color: #f8f8f2">/</span> <span class="token maybe-class-name">Provider</span> <span class="token operator" style="color: #f8f8f2">&gt;</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Grab the initial state from our Redux store</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> preloadedState </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> store</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">getState</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Send the rendered page back to the client</span> <span class="token plain"> </span></p>
<p><span class="token plain"> res</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">send</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token function" style="color: #e6d874">renderFullPage</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">html</span> <span class="token punctuation" style="color: #f8f8f2">,</span> <span class="token plain"> preloadedState</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">}</span>### <span id="inject-initial-component-html-and-state" class="anchor enhancedAnchor_2LWZ"> </span>Inject Initial Component HTML and State<a href="#inject-initial-component-html-and-state" class="hash-link" title="Direct link to heading">#</a></p>
<p>The final step on the server side is to inject our initial component HTML and initial state into a template to be rendered on the client side. To pass along the state, we add a <code>&lt;script&gt;</code> tag that will attach <code>preloadedState</code> to <code>window.__PRELOADED_STATE__</code>.</p>
<p>The <code>preloadedState</code> will then be available on the client side by accessing <code>window.__PRELOADED_STATE__</code>.</p>
<p>We also include our bundle file for the client-side application via a script tag. This is whatever output your bundling tool provides for your client entry point. It may be a static file or a URL to a hot reloading development server.</p>
<p><span class="token keyword" style="color: #f92672">function</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">renderFullPage</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token parameter">html</span> <span class="token parameter punctuation" style="color: #f8f8f2">,</span> <span class="token parameter"> preloadedState</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword control-flow" style="color: #f92672">return</span> <span class="token plain"> </span> <span class="token template-string template-punctuation string" style="color: #a6e22e">`</span> <span class="token template-string string" style="color: #a6e22e"> </span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;!doctype html&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;html&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;head&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;title&gt;Redux Universal Example&lt;/title&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;/head&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;body&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;div id=“root”&gt;</span> <span class="token template-string interpolation interpolation-punctuation punctuation" style="color: #f8f8f2">${</span> <span class="token template-string interpolation">html</span> <span class="token template-string interpolation interpolation-punctuation punctuation" style="color: #f8f8f2">}</span> <span class="token template-string string" style="color: #a6e22e">&lt;/div&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;script&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> // WARNING: See the following for security issues around embedding JSON in HTML:</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> // https://redux.js.org/recipes/server-rendering/#security-considerations</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> window.__PRELOADED_STATE__ = </span> <span class="token template-string interpolation interpolation-punctuation punctuation" style="color: #f8f8f2">${</span> <span class="token template-string interpolation constant" style="color: #f92672">JSON</span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">.</span> <span class="token template-string interpolation function" style="color: #e6d874">stringify</span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">(</span> <span class="token template-string interpolation">preloadedState</span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">)</span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">.</span> <span class="token template-string interpolation function" style="color: #e6d874">replace</span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">(</span> <span class="token template-string interpolation"> </span></p>
<p><span class="token template-string interpolation"> </span> <span class="token template-string interpolation regex regex-delimiter" style="color: #fd971f">/</span> <span class="token template-string interpolation regex regex-source language-regex" style="color: #fd971f">&lt;</span> <span class="token template-string interpolation regex regex-delimiter" style="color: #fd971f">/</span> <span class="token template-string interpolation regex regex-flags" style="color: #fd971f">g</span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">,</span> <span class="token template-string interpolation"> </span></p>
<p><span class="token template-string interpolation"> </span> <span class="token template-string interpolation string" style="color: #a6e22e">‘\\u003c’</span> <span class="token template-string interpolation"> </span></p>
<p><span class="token template-string interpolation"> </span> <span class="token template-string interpolation punctuation" style="color: #f8f8f2">)</span> <span class="token template-string interpolation interpolation-punctuation punctuation" style="color: #f8f8f2">}</span> <span class="token template-string string" style="color: #a6e22e"> </span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;/script&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;script src=“/static/bundle.js”&gt;&lt;/script&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;/body&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> &lt;/html&gt;</span></p>
<p><span class="token template-string string" style="color: #a6e22e"> </span> <span class="token template-string template-punctuation string" style="color: #a6e22e">`</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">}</span>## <span id="the-client-side" class="anchor enhancedAnchor_2LWZ"> </span>The Client Side<a href="#the-client-side" class="hash-link" title="Direct link to heading">#</a></p>
<p>The client side is very straightforward. All we need to do is grab the initial state from <code>window.__PRELOADED_STATE__</code>, and pass it to our <a href="../api/createstore.html"><code>createStore()</code></a> function as the initial state.</p>
<p>Let’s take a look at our new client file:</p>
<h4 id="section-5"><span id="clientjs" class="anchor enhancedAnchor_2LWZ"></h4>
<p></span><code>client.js</code><a href="#clientjs" class="hash-link" title="Direct link to heading">#</a></p>
<p><span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports maybe-class-name">React</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> hydrate </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react-dom’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> createStore </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘redux’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> </span> <span class="token imports maybe-class-name">Provider</span> <span> </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react-redux’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports maybe-class-name">App</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘./containers/App’</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span>counterApp</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘./reducers’</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Grab the state from a global variable injected into the server-generated HTML</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> preloadedState </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token dom variable" style="color: #f8f8f2">window</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span class="token property-access">__PRELOADED_STATE__</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Allow the passed state to be garbage-collected</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">delete</span> <span class="token plain"> </span> <span class="token dom variable" style="color: #f8f8f2">window</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span class="token property-access">__PRELOADED_STATE__</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Create Redux store with initial state</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> store </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">createStore</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">counterApp</span> <span class="token punctuation" style="color: #f8f8f2">,</span> <span class="token plain"> preloadedState</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token function" style="color: #e6d874">hydrate</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">&lt;</span> <span class="token maybe-class-name">Provider</span> <span class="token plain"> store</span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain">store</span> <span class="token punctuation" style="color: #f8f8f2">}</span> <span class="token operator" style="color: #f8f8f2">&gt;</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">&lt;</span> <span class="token maybe-class-name">App</span> <span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">/</span> <span class="token operator" style="color: #f8f8f2">&gt;</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">&lt;</span> <span class="token operator" style="color: #f8f8f2">/</span> <span class="token maybe-class-name">Provider</span> <span class="token operator" style="color: #f8f8f2">&gt;</span> <span class="token punctuation" style="color: #f8f8f2">,</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token dom variable" style="color: #f8f8f2">document</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">getElementById</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token string" style="color: #a6e22e">‘root’</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">)</span>You can set up your build tool of choice (Webpack, Browserify, etc.) to compile a bundle file into <code>static/bundle.js</code>.</p>
<p>When the page loads, the bundle file will be started up and <a href="../../reactjs.org/docs/react-dom.html#hydrate"><code>ReactDOM.hydrate()</code></a> will reuse the server-rendered HTML. This will connect our newly-started React instance to the virtual DOM used on the server. Since we have the same initial state for our Redux store and used the same code for all our view components, the result will be the same real DOM.</p>
<p>And that’s it! That is all we need to do to implement server side rendering.</p>
<p>But the result is pretty vanilla. It essentially renders a static view from dynamic code. What we need to do next is build an initial state dynamically to allow that rendered view to be dynamic.</p>
<h2 id="section-6"><span id="preparing-the-initial-state" class="anchor enhancedAnchor_2LWZ"></h2>
<p></span>Preparing the Initial State<a href="#preparing-the-initial-state" class="hash-link" title="Direct link to heading">#</a></p>
<p>Because the client side executes ongoing code, it can start with an empty initial state and obtain any necessary state on demand and over time. On the server side, rendering is synchronous and we only get one shot to render our view. We need to be able to compile our initial state during the request, which will have to react to input and obtain external state (such as that from an API or database).</p>
<h3 id="section-7"><span id="processing-request-parameters" class="anchor enhancedAnchor_2LWZ"></h3>
<p></span>Processing Request Parameters<a href="#processing-request-parameters" class="hash-link" title="Direct link to heading">#</a></p>
<p>The only input for server side code is the request made when loading up a page in your app in your browser. You may choose to configure the server during its boot (such as when you are running in a development vs. production environment), but that configuration is static.</p>
<p>The request contains information about the URL requested, including any query parameters, which will be useful when using something like <a href="../../github.com/ReactTraining/react-router.html">React Router</a>. It can also contain headers with inputs like cookies or authorization, or POST body data. Let’s see how we can set the initial counter state based on a query parameter.</p>
<h4 id="section-8"><span id="serverjs-1" class="anchor enhancedAnchor_2LWZ"></h4>
<p></span><code>server.js</code><a href="#serverjs-1" class="hash-link" title="Direct link to heading">#</a></p>
<p><span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span>qs</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘qs’</span> <span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Add this at the top of the file</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">import</span> <span class="token plain"> </span> <span class="token imports punctuation" style="color: #f8f8f2">{</span> <span> renderToString </span> <span class="token imports punctuation" style="color: #f8f8f2">}</span> <span class="token plain"> </span> <span class="token keyword module" style="color: #f92672">from</span> <span class="token plain"> </span> <span class="token string" style="color: #a6e22e">‘react-dom/server’</span> <span class="token plain"> </span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">function</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">handleRender</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token parameter">req</span> <span class="token parameter punctuation" style="color: #f8f8f2">,</span> <span class="token parameter"> res</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span> <span class="token punctuation" style="color: #f8f8f2">{</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token comment" style="color: #c6cad2">// Read the counter from the request, if provided</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> params </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> qs</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span style="color: #e6d874">parse</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">req</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span class="token property-access">query</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span></p>
<p><span class="token plain"> </span> <span class="token keyword" style="color: #f92672">const</span> <span class="token plain"> counter </span> <span class="token operator" style="color: #f8f8f2">=</span> <span class="token plain"> </span> <span class="token function" style="color: #e6d874">parseInt</span> <span class="token punctuation" style="color: #f8f8f2">(</span> <span class="token plain">params</span> <span class="token punctuation" style="color: #f8f8f2">.</span> <span class="token property-access">counter</span> <span class="token punctuation" style="color: #f8f8f2">,</span> <span class="token plain"> </span> <span class="token number" style="color: #ae81ff">10</span> <span class="token punctuation" style="color: #f8f8f2">)</span> <span class="token plain"> </span> <span class="token operator" style="color: #f8f8f2">||</span><span class="token plain"> </span><span class="token number" style="color: #ae81ff">0</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Compile an initial state</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">let</span><span class="token plain"> preloadedState </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"> counter </span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Create a new Redux store instance</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> store </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">createStore</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">counterApp</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> preloadedState</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Render the component to a string</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> html </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">renderToString</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator" style="color: #f8f8f2">=</span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain">store</span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token operator" style="color: #f8f8f2">&gt;</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">/</span><span class="token operator" style="color: #f8f8f2">&gt;</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">&lt;</span><span class="token operator" style="color: #f8f8f2">/</span><span class="token maybe-class-name">Provider</span><span class="token operator" style="color: #f8f8f2">&gt;</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Grab the initial state from our Redux store</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> finalState </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> store</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Send the rendered page back to the client</span><span class="token plain"></span></p>
<p><span class="token plain"> res</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">send</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token function" style="color: #e6d874">renderFullPage</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">html</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> finalState</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain"></span><span class="token punctuation" style="color: #f8f8f2">}</span>The code reads from the Express <code>Request</code> object passed into our server middleware. The parameter is parsed into a number and then set in the initial state. If you visit <a href="../../localhost_3000/indexc97d.html?counter=100">http://localhost:3000/?counter=100</a> in your browser, you’ll see the counter starts at 100. In the rendered HTML, you’ll see the counter output as 100 and the <code>__PRELOADED_STATE__</code> variable has the counter set in it.</p>
<h3 id="async-state-fetching"><span id="async-state-fetching" class="anchor enhancedAnchor_2LWZ"></span>Async State Fetching<a href="#async-state-fetching" class="hash-link" title="Direct link to heading">#</a></h3>
<p>The most common issue with server side rendering is dealing with state that comes in asynchronously. Rendering on the server is synchronous by nature, so it’s necessary to map any asynchronous fetches into a synchronous operation.</p>
<p>The easiest way to do this is to pass through some callback back to your synchronous code. In this case, that will be a function that will reference the response object and send back our rendered HTML to the client. Don’t worry, it’s not as hard as it may sound.</p>
<p>For our example, we’ll imagine there is an external datastore that contains the counter’s initial value (Counter As A Service, or CaaS). We’ll make a mock call over to them and build our initial state from the result. We’ll start by building out our API call:</p>
<h4 id="apicounter.js"><span id="apicounterjs" class="anchor enhancedAnchor_2LWZ"></span><code>api/counter.js</code><a href="#apicounterjs" class="hash-link" title="Direct link to heading">#</a></h4>
<p><span class="token keyword" style="color: #f92672">function</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">getRandomInt</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token parameter">min</span><span class="token parameter punctuation" style="color: #f8f8f2">,</span><span class="token parameter"> max</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">floor</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">random</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">*</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">max </span><span class="token operator" style="color: #f8f8f2">-</span><span class="token plain"> min</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">+</span><span class="token plain"> min</span></p>
<p><span class="token plain"></span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"></span><span class="token keyword module" style="color: #f92672">export</span><span class="token plain"> </span><span class="token keyword" style="color: #f92672">function</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">fetchCounter</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token parameter">callback</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token function" style="color: #e6d874">setTimeout</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color: #f8f8f2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token function" style="color: #e6d874">callback</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token function" style="color: #e6d874">getRandomInt</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token number" style="color: #ae81ff">1</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color: #ae81ff">100</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color: #ae81ff">500</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain"></span><span class="token punctuation" style="color: #f8f8f2">}</span>Again, this is just a mock API, so we use <code>setTimeout</code> to simulate a network request that takes 500 milliseconds to respond (this should be much faster with a real world API). We pass in a callback that returns a random number asynchronously. If you’re using a Promise-based API client, then you would issue this callback in your <code>then</code> handler.</p>
<p>On the server side, we simply wrap our existing code in the <code>fetchCounter</code> and receive the result in the callback:</p>
<h4 id="server.js"><span id="serverjs-2" class="anchor enhancedAnchor_2LWZ"></span><code>server.js</code><a href="#serverjs-2" class="hash-link" title="Direct link to heading">#</a></h4>
<p><span class="token comment" style="color: #c6cad2">// Add this to our imports</span><span class="token plain"></span></p>
<p><span class="token plain"></span><span class="token keyword module" style="color: #f92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color: #f8f8f2">{</span><span> fetchCounter </span><span class="token imports punctuation" style="color: #f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color: #f92672">from</span><span class="token plain"> </span><span class="token string" style="color: #a6e22e">‘./api/counter’</span><span class="token plain"></span></p>
<p><span class="token plain"></span><span class="token keyword module" style="color: #f92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color: #f8f8f2">{</span><span> renderToString </span><span class="token imports punctuation" style="color: #f8f8f2">}</span><span class="token plain"> </span><span class="token keyword module" style="color: #f92672">from</span><span class="token plain"> </span><span class="token string" style="color: #a6e22e">‘react-dom/server’</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"></span><span class="token keyword" style="color: #f92672">function</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">handleRender</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color: #f8f8f2">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Query our mock API asynchronously</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token function" style="color: #e6d874">fetchCounter</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token parameter">apiResult</span><span class="token plain"> </span><span class="token arrow operator" style="color: #f8f8f2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Read the counter from the request, if provided</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> params </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> qs</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">parse</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">req</span><span class="token punctuation" style="color: #f8f8f2">.</span><span class="token property-access">query</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> counter </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">parseInt</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">params</span><span class="token punctuation" style="color: #f8f8f2">.</span><span class="token property-access">counter</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color: #ae81ff">10</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">||</span><span class="token plain"> apiResult </span><span class="token operator" style="color: #f8f8f2">||</span><span class="token plain"> </span><span class="token number" style="color: #ae81ff">0</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Compile an initial state</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">let</span><span class="token plain"> preloadedState </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain"> counter </span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Create a new Redux store instance</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> store </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">createStore</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">counterApp</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> preloadedState</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Render the component to a string</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> html </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> </span><span class="token function" style="color: #e6d874">renderToString</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator" style="color: #f8f8f2">=</span><span class="token punctuation" style="color: #f8f8f2">{</span><span class="token plain">store</span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token operator" style="color: #f8f8f2">&gt;</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">/</span><span class="token operator" style="color: #f8f8f2">&gt;</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token operator" style="color: #f8f8f2">&lt;</span><span class="token operator" style="color: #f8f8f2">/</span><span class="token maybe-class-name">Provider</span><span class="token operator" style="color: #f8f8f2">&gt;</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Grab the initial state from our Redux store</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token keyword" style="color: #f92672">const</span><span class="token plain"> finalState </span><span class="token operator" style="color: #f8f8f2">=</span><span class="token plain"> store</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain" style="display: inline-block"> </span></p>
<p><span class="token plain"> </span><span class="token comment" style="color: #c6cad2">// Send the rendered page back to the client</span><span class="token plain"></span></p>
<p><span class="token plain"> res</span><span class="token punctuation" style="color: #f8f8f2">.</span><span style="color: #e6d874">send</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token function" style="color: #e6d874">renderFullPage</span><span class="token punctuation" style="color: #f8f8f2">(</span><span class="token plain">html</span><span class="token punctuation" style="color: #f8f8f2">,</span><span class="token plain"> finalState</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain"> </span><span class="token punctuation" style="color: #f8f8f2">}</span><span class="token punctuation" style="color: #f8f8f2">)</span><span class="token plain"></span></p>
<p><span class="token plain"></span><span class="token punctuation" style="color: #f8f8f2">}</span>Because we call <code>res.send()</code> inside of the callback, the server will hold open the connection and won’t send any data until that callback executes. You’ll notice a 500ms delay is now added to each server request as a result of our new API call. A more advanced usage would handle errors in the API gracefully, such as a bad response or timeout.</p>
<h3 id="security-considerations"><span id="security-considerations" class="anchor enhancedAnchor_2LWZ"></span>Security Considerations<a href="#security-considerations" class="hash-link" title="Direct link to heading">#</a></h3>
<p>Because we have introduced more code that relies on user generated content (UGC) and input, we have increased our attack surface area for our application. It is important for any application that you ensure your input is properly sanitized to prevent things like cross-site scripting (XSS) attacks or code injections.</p>
<p>In our example, we take a rudimentary approach to security. When we obtain the parameters from the request, we use <code>parseInt</code> on the <code>counter</code> parameter to ensure this value is a number. If we did not do this, you could easily get dangerous data into the rendered HTML by providing a script tag in the request. That might look like this: <code>?counter=&lt;/script&gt;&lt;script&gt;doSomethingBad();&lt;/script&gt;</code></p>
<p>For our simplistic example, coercing our input into a number is sufficiently secure. If you’re handling more complex input, such as freeform text, then you should run that input through an appropriate sanitization function, such as <a href="../../github.com/YahooArchive/xss-filters.html">xss-filters</a>.</p>
<p>Furthermore, you can add additional layers of security by sanitizing your state output. <code>JSON.stringify</code> can be subject to script injections. To counter this, you can scrub the JSON string of HTML tags and other dangerous characters. This can be done with either a simple text replacement on the string, e.g. <code>JSON.stringify(state).replace(/&lt;/g, '\\u003c')</code>, or via more sophisticated libraries such as <a href="../../github.com/yahoo/serialize-javascript.html">serialize-javascript</a>.</p>
<h2 id="next-steps"><span id="next-steps" class="anchor enhancedAnchor_2LWZ"></span>Next Steps<a href="#next-steps" class="hash-link" title="Direct link to heading">#</a></h2>
<p>You may want to read <a href="../tutorials/fundamentals/part-6-async-logic.html">Redux Fundamentals Part 6: Async Logic and Data Fetching</a> to learn more about expressing asynchronous flow in Redux with async primitives such as Promises and thunks. Keep in mind that anything you learn there can also be applied to universal rendering.</p>
<p>If you use something like <a href="../../github.com/ReactTraining/react-router.html">React Router</a>, you might also want to express your data fetching dependencies as static <code>fetchData()</code> methods on your route handler components. They may return <a href="../tutorials/fundamentals/part-6-async-logic.html">thunks</a>, so that your <code>handleRender</code> function can match the route to the route handler component classes, dispatch <code>fetchData()</code> result for each of them, and render only after the Promises have resolved. This way the specific API calls required for different routes are colocated with the route handler component definitions. You can also use the same technique on the client side to prevent the router from switching the page until its data has been loaded.</p>
<p><a href="reducing-boilerplate.html" class="pagination-nav__link"></a></p>
<p>« Reducing Boilerplate</p>
<p><a href="writing-tests.html" class="pagination-nav__link"></a></p>
<p>Next</p>
<p>Writing Tests »</p>
<ul>
<li><a href="#redux-on-the-server" class="table-of-contents__link">Redux on the Server</a></li>
<li><a href="#setting-up" class="table-of-contents__link">Setting Up</a>
<ul>
<li><a href="#install-packages" class="table-of-contents__link">Install Packages</a></li>
</ul></li>
<li><a href="#the-server-side" class="table-of-contents__link">The Server Side</a>
<ul>
<li><a href="#handling-the-request" class="table-of-contents__link">Handling the Request</a></li>
<li><a href="#inject-initial-component-html-and-state" class="table-of-contents__link">Inject Initial Component HTML and State</a></li>
</ul></li>
<li><a href="#the-client-side" class="table-of-contents__link">The Client Side</a></li>
<li><a href="#preparing-the-initial-state" class="table-of-contents__link">Preparing the Initial State</a>
<ul>
<li><a href="#processing-request-parameters" class="table-of-contents__link">Processing Request Parameters</a></li>
<li><a href="#async-state-fetching" class="table-of-contents__link">Async State Fetching</a></li>
<li><a href="#security-considerations" class="table-of-contents__link">Security Considerations</a></li>
</ul></li>
<li><a href="#next-steps" class="table-of-contents__link">Next Steps</a></li>
</ul>
<h4 id="docs">Docs</h4>
<ul>
<li><a href="../introduction/getting-started.html" class="footer__link-item">Getting Started</a></li>
<li><a href="../tutorials/essentials/part-1-overview-concepts.html" class="footer__link-item">Tutorial</a></li>
<li><a href="../faq.html" class="footer__link-item">FAQ</a></li>
<li><a href="../api/api-reference.html" class="footer__link-item">API Reference</a></li>
</ul>
<h4 id="community">Community</h4>
<ul>
<li><a href="../official/discord.com/invite/0ZcbPKXt5bZ6au5t.html" class="footer__link-item">Reactiflux Discord</a></li>
<li><a href="../official/stackoverflow.com/questions/tagged/redux.html" class="footer__link-item">Stack Overflow</a></li>
<li><a href="../introduction/getting-started.html#help-and-discussion" class="footer__link-item">Feedback</a></li>
</ul>
<h4 id="more">More</h4>
<ul>
<li><a href="../official/github.com/reduxjs/redux.html" class="footer__link-item">GitHub</a></li>
<li><a href="../../www.netlify.com/index.html"><img src="../../www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify" /></a></li>
</ul>
<p><a href="../index.html" class="footerLogoLink_MyFc"><img src="../official/d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo" /><img src="../official/d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo" /></a></p>
</body>
</html>
